name: Run CI/CD

on:
  push:
    branches:
      - main  # mainブランチへの直接pushによるトリガー
  pull_request:
    types: [opened, synchronize, reopened]  # PR作成時・更新時にトリガー
    branches: ["**"]  # すべてのブランチへのPRをトリガー

# 明示的なパーミッション設定
permissions:
  contents: read # リポジトリコンテンツの読み取り権限
  issues: write
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Bun
        run: npm install -g bun

      # node_modulesとbun-cacheのキャッシングを手動で実装
      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run linter
        run: bun run check

  typecheck:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Bun
        run: npm install -g bun

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run TypeScript type check
        run: bun run typecheck

  test:
    runs-on: ubuntu-latest
    # lintの後に実行
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install Bun
        run: npm install -g bun

      # node_modulesとbun-cacheのキャッシングを手動で実装
      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: bun run test

#   # E2E tests - disabled for Expo (consider using Detox in the future)
#   e2e-test:
#     name: End-to-End Tests
#     runs-on: ubuntu-latest
#     needs: lint
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20.x'
#
#       - name: Install Bun
#         run: npm install -g bun
#
#       - name: Cache Bun dependencies
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.bun/install/cache
#             node_modules
#           key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
#           restore-keys: |
#             ${{ runner.os }}-bun-
#
#       - name: Install dependencies
#         run: bun install
#
#       - name: Run E2E tests
#         run: bun run test:e2e
